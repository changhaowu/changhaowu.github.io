I"Ü(<ul class="table-of-content" id="markdown-toc">
  <li><a href="#analytical-function-case" id="markdown-toc-analytical-function-case">Analytical Function Case</a></li>
  <li><a href="#intermediated-states-case" id="markdown-toc-intermediated-states-case">Intermediated States Case</a></li>
  <li><a href="#ode-controlled-case" id="markdown-toc-ode-controlled-case">ODE controlled Case</a></li>
</ul>
<p>Adjoint States Methods åœ¨æ•°å€¼è®¡ç®—ä¸­éå¸¸çš„æœ‰ç”¨ï¼Œå…¶åœ¨1960å¹´ä»£ç”± Pontryagin æå‡ºä»¥æ›´é«˜æ•ˆçš„è®¡ç®—æ¢¯åº¦ï¼Œåœ¨å¦‚åœ°éœ‡å­¦ï¼Œå†°å·å­¦ç­‰å­¦ç§‘çš„æ•°å€¼æ¨¡æ‹Ÿä¸­å¹¿æ³›åº”ç”¨ï¼Œè€Œè¿‘æ¥ç¥ç»ç½‘ç»œçš„ä¼˜åŒ–é—®é¢˜èŒƒå¼åŒæ ·ç¬¦åˆ Adjoint States Methods ä½¿ç”¨èŒƒç•´ï¼Œå½“åœ¨ç¥ç»ç½‘ç»œä¸­ä½¿ç”¨æ—¶ï¼Œä»–è¿˜æœ‰ä¸ªæ›´æœ‰åçš„åå­— â€˜Back Propagationâ€™ï¼Œæ›´å·§å¦™çš„æ˜¯ï¼Œåœ¨ NIPS 2018 best paper winner â€˜Neural Ordinary Differential Equationsâ€™ ä¸­ï¼ŒAdjoint States Methods çš„åº”ç”¨ä½¿å¾—æ¢¯åº¦å¯¹äºå†…å­˜çš„è®¡ç®—å¤æ‚åº¦ä» O(n) é™è‡³ O(1)ï¼Œæ¢è¨€ä¹‹ï¼Œä»è¦æŠŠæ•´ä¸ªç½‘ç»œçš„è®¡ç®—å›¾å­˜ä¸‹æ¥çš„ä¸€èˆ¬ Back Propagation, Adjoint States Methods æŠŠæ¢¯åº¦ä¸‹é™å˜æˆäº†ä¸€ä¸ªé€å±‚è¿­ä»£æ±‚è§£çš„é—®é¢˜</p>

<p>äºæ˜¯ç°åœ¨ä¼˜åŒ–é—®é¢˜çš„å®šä¹‰å¼€å§‹ï¼Œç°åœ¨æœ‰è¾“å…¥ $x \in \mathbb{R}^{n_{x}}$ï¼Œæ§åˆ¶ $p \in \mathbb{R}^{n_{p}}$, æœ‰ä¼˜åŒ–é—®é¢˜ï¼š</p>

\[\arg_{p} \min J(x, p) \ \ \ J: \mathbb{R}^{n_{x}} \times \mathbb{R}^{n_{p}} \rightarrow \mathbb{R}
\\
s.t \ \ \ f(x, p)=0  \ \ \ f: \mathbb{R}^{n_{x}} \times \mathbb{R}^{n_{p}} \rightarrow \mathbb{R}^{n_{x}}\]

<p>å¦‚æœä»¥ç¥ç»ç½‘ç»œçš„è§†è§’æ¥çœ‹çš„è¯ï¼Œ$J$ å³ä»£è¡¨æŸå¤±å‡½æ•°ï¼Œè€Œæ§åˆ¶ $p$ å…¶å®å°±æ˜¯æ§åˆ¶ç½‘ç»œçš„å‚æ•°ï¼Œé€å±‚æ¥å®šä¹‰ç½‘ç»œä¸­çš„ hidden layers</p>

<p>ä¸ºäº†å¯¹ç ”ç©¶çš„æƒ…å†µåšä¸€äº›åˆ†ç±»ï¼Œ å¯ä»¥ä» $J(x, p)$ çš„è§’åº¦æ¥çœ‹ï¼Œåœ¨ â€˜16-90-computational-methods-in-aerospace-engineeringâ€™ ä¸­ï¼Œ Qiqi Wang æ•™æˆå®šä¹‰äº†äº”ç§æƒ…å†µï¼š</p>

<ol>
  <li>
    <p>è§£æçš„ $J(x, p)$ï¼Œè¿™æ ·ç›´æ¥è®¡ç®—å³å¯</p>
  </li>
  <li>
    <p>å­˜åœ¨ intermediate state çš„ $x_i$ çš„ $J(x_i, p)$â€‹, ç¥ç»ç½‘ç»œå°±å±äºè¿™ç§æƒ…å†µ</p>

\[x_{n}=x_{n}\left(x_{n-1}, p\right)
\\
x_{0}=x_{0}(p)\]
  </li>
  <li>
    <p>$x$ ç”±ä¸€ä¸ªODEæ§åˆ¶</p>

\[J(x(t), p)   \ \ \    s.t \ \frac{d x}{d t}=f(x, p)\]
  </li>
  <li>
    <p>$x,p$ ç”±ä¸€ä¸ªéšå‡½æ•° $f(x, p)=0$ æ§åˆ¶</p>
  </li>
  <li>
    <p>$x$ ç”±ä¸€ä¸ªPDEæ§åˆ¶, $J(x(y,t), p) $</p>
  </li>
</ol>

<p>ä¸‹æ–‡çš„è¡Œæ–‡ç»“æ„åšå¦‚æ­¤å®‰æ’ï¼šé€šè¿‡ç¬¬ä¸€ç§æƒ…å†µæ¥å™è¿° Adjoint States Method çš„æ€æƒ³ï¼Œé€šè¿‡ç¬¬äºŒç§æƒ…å†µæ¥å±•ç° Back Propagation å’Œ Adjoint States Method çš„ç­‰ä»·æ€§ï¼Œé€šè¿‡ç¬¬ä¸‰ç§æƒ…å†µæ¥åˆ†æ Neural ODEs ä¸­åˆ©ç”¨ Adjoint States Method æ¥å‡å°‘è®¡ç®—å†…å­˜å¤æ‚åº¦çš„æ–¹æ³•</p>

<h3 id="analytical-function-case">Analytical Function Case</h3>

<p>é€šè¿‡å®šä¹‰æ‹‰æ ¼æœ—æ—¥å‡½æ•° $\mathcal{L}(x, p, \lambda) \equiv J(x,p)+\lambda^{T} f(x, p)$ï¼Œ åŒæ—¶ç”±äº $f(x, p) = 0$, å¯çŸ¥ $x = x(p)$ï¼Œè¿™æ ·å¯ä»¥åŒ–ä»£ä»·å‡½æ•° $J(x,p)$ ä¸º $J(x(p))$</p>

\[\begin{aligned} 
\mathrm{d}_{p} f(x)=\mathrm{d}_{p} \mathcal{L} &amp;=\partial_{x} J \mathrm{~d}_{p} x+\mathrm{d}_{p} \lambda^{T} f+\lambda^{T}\left(\partial_{x} f \mathrm{~d}_{p} x+\partial_{p} f\right) 
\\
&amp;=J_{x} x_{p}+ \lambda^{T}\left(f_{x} x_{p}+f_{p}\right) \quad \text { because } f=0 \text { everywhere }
\\ 
&amp;=\left(J_{x}+\lambda^{T} f_{x}\right) x_{p}+\lambda^{T} f_{p}  
\end{aligned}\]

<p>ä¸ºäº†æ–¹ä¾¿è®¡ç®— $d_p f $ï¼Œå…¶ä¸­ $f_{p},J_{p}$ éƒ½æ˜¯å¯ä»¥ç›´æ¥è§£æè®¡ç®—çš„ï¼Œè€Œ $x_{p}$ åˆ™éœ€è¦é€šè¿‡æ•´ä¸ªç½‘ç»œè¿­ä»£é‡æ–°è®¡ç®—ï¼Œä¸ºäº†è®¡ç®—æ¢¯åº¦çš„ä¾¿æ·æ€§ï¼Œå¾—åˆ°äº†æ‹‰æ ¼æœ—æ—¥ä¹˜å­ $f_{x}^{T} \lambda=-J_{x}^{T}$ï¼Œé‚£ä¹ˆ $d_p J=\lambda^{T} f_p $</p>

<p>è€Œ $\lambda = -(f_{x}^{-1})^{T}J_{x}^{T}$ ï¼Œè¿™ç§å…±è½­è½¬ç½®è¢«ç§°ä¸º adjoint variableï¼Œè¿™ä¹Ÿæ˜¯è¿™æ ·è®¡ç®—æ¢¯åº¦çš„æ–¹æ³•è¢«ç§°ä¸º adjoint state method çš„åŸå› </p>

<h3 id="intermediated-states-case">Intermediated States Case</h3>

<p>ç°åœ¨æœ‰å¦‚ä¸‹è®¡ç®—å›¾:</p>

<p style="text-align: center;"><img src="/images/2021-12-07-Adjoint-Methods-and-Auto-Differentiation/intermediate_states_graph.png" alt="intermediate_states_graph" style="zoom:40%;" /></p>

<p>é€šè¿‡ BP ç®—æ³•æˆ‘ä»¬å·²ç»çŸ¥é“äº† $d_p J$ çš„å½¢å¼äº†ï¼Œè€Œé€šè¿‡ adjoint method å¯ä»¥å¾—åˆ°åŒæ ·çš„ç»“æœï¼š</p>

<p>ç¥ç»ç½‘ç»œé€å±‚è½¬æ’­çš„è¿‡ç¨‹å¯ä»¥å½¢æˆå¦‚ä¸‹çº¦æŸ</p>

\[\left\{\begin{array}{l}
x_{0}=x_{0}(p) \\
x_{i}=x_{i}\left(x_{i-1}, p\right)
\end{array}\right.\]

<p>äºæ˜¯æœ‰æ‹‰æ ¼æœ—æ—¥å‡½æ•°</p>

<p>$L(x, p, \lambda)=J\left(x_{n}\right)+\lambda_{n}^{T}\left(x_{n}-x_{n}\left(x_{n-1}, p\right)\right)+\cdots+\lambda_{1}^{\top}\left(x_{1}-x_{1}\left(x_{0}, p\right)\right)+\lambda_{0}^{\top}\left(x_{0}-x_{}\left(p\right)\right) $</p>

<p>å¯¹å…¶åšæ‰°åŠ¨ï¼Œå¯ä»¥å¾—åˆ°</p>

\[\begin{aligned} 
\delta L=\frac{\partial J}{\partial x_{n}} \delta x_{n} &amp;+\lambda_{n}^{T}\left(\delta x_{n}-\frac{\partial x_{n}}{\partial x_{n-1}} \delta x_{n-1}-\frac{\partial x_{n}}{\partial p} \delta p\right) 
\\ &amp;+\lambda_{n-1}^{T}\left(\delta x_{n-1}-\frac{\partial x_{n-1}}{\partial x_{n-2}} \delta x_{n-2}-\frac{\partial x_{n-1}}{\partial p} \delta p\right) 
\\ &amp;+\cdots 
\\ &amp;+\lambda_{0}^{T}\left(\delta x_{0} + \frac{d x_{0}}{d p} \delta p\right).
\end{aligned}\]

<p>ç±»ä¼¼æœ€ç®€å•æƒ…å†µçš„æƒ³æ³•ï¼Œä¸ºäº†å‡å°‘åç»­è®¡ç®— $\frac{\partial L}{\partial p}$ çš„è®¡ç®—é‡ï¼Œéœ€è¦æŠŠåå¤è®¡ç®—çš„ $\delta x_{i}$ æ¶ˆå»ï¼Œç”±æ­¤å¾—åˆ°äº†å…³äºå„ä¸ª $\lambda_{i}^{T}$ çš„çº¦æŸï¼Œä»£å…¥å¹¶æ¶ˆå»å¤šä½™é¡¹åæœ‰ï¼š</p>

\[\frac{\partial J}{\partial p}=\sum_{i }\frac{\partial E}{\partial x_i} \frac{\partial x_i}{\partial p}\]

<h3 id="ode-controlled-case">ODE controlled Case</h3>

<p>è¿™ç§å¯¹å¶æ±‚è§£æ¢¯åº¦çš„æ–¹æ³•åœ¨ç‰¹æ®Šæƒ…å†µä¸‹ä¼šæœ‰æ„æ–™ä¹‹å¤–çš„æ•ˆæœï¼Œåœ¨å‰ é¢ä¸¤èŠ‚æˆ‘ä»¬è¯æ˜äº†è¿™ç§å¯¹å¶æ–¹æ³•æ±‚è§£çš„ç»“æœå’ŒåŸé—®é¢˜æ±‚è§£çš„æ¢¯åº¦æ˜¯ç­‰ä»·çš„ï¼Œè€Œåœ¨è¿™èŠ‚ä¸­ï¼Œå€ŸåŠ©ç‰¹æ®Šæƒ…å†µçš„çº¦æŸå‡½æ•° $f(x, p) = 0$ï¼Œadjoint method åœ¨ç‰¹æ®Šæƒ…å†µä¸‹å±•ç°å‡ºäº†æ¯”åŸé—®é¢˜æ±‚æ¢¯åº¦æ›´åŠ ä¼˜ç§€çš„æ•°å€¼è®¡ç®—æ€§è´¨</p>

<p>ç”±äºè€ƒè™‘åˆ°ODEçš„çº¦æŸ $\frac{d z}{d t}=f_{\theta}(s, x, z)$ï¼Œå…¶ä¸­ $s$ ä¸ºç½‘ç»œæ·±åº¦çš„è¾“å…¥ï¼Œå‚æ•° $\theta$ ä¸ºç½‘ç»œçš„æ§åˆ¶ï¼Œ åˆ™å¾ˆè‡ªç„¶çš„ä½¿ç”¨ä¸€ä¸ªå¯¹æ—¶é—´ç§¯åˆ†çš„çº¦æŸï¼Œå†™å‡ºæ‹‰æ ¼æœ—æ—¥å‡½æ•°ï¼š</p>

\[L:=J-\int_{0} \mathbf{a}^{\top}(\tau)\left[\dot{\mathbf{z}}(\tau)-f_{\theta}\left(s, \mathbf{x}, \mathbf{z}(\tau)\right)\right] \mathrm{d} \tau\]

<p>ç”±äºæ„é€ çš„æ‹‰æ ¼æœ—æ—¥ä¹˜å­ï¼Œç±»ä¼¼ä¹‹å‰çš„æƒ…å†µï¼Œ$\mathrm{d} \mathcal{L} / \mathrm{d} \theta=\mathrm{d} \ell / \mathrm{d} \theta$ï¼Œå±•å¼€ä¸Šå¼ï¼š</p>

\[\begin{aligned} \mathcal{L} &amp;=\ell-\left.\mathbf{a}^{\top}(\tau) \mathbf{z}(\tau)\right|_{0} ^{S}+\int_{0}^{S}\left(\dot{\mathbf{a}}^{\top} \mathbf{z}+\mathbf{a}^{\top} f_{\theta}\right) \mathrm{d} \tau \\ &amp;=L(\mathbf{z}(S))-\left.\mathbf{a}^{\top}(\tau) \mathbf{z}(\tau)\right|_{0} ^{S}+\int_{0}^{S}\left(\dot{\mathbf{a}}^{\top} \mathbf{z}+\mathbf{a}^{\top} f_{\theta}+l\right) \mathrm{d} \tau \end{aligned}\]

<p>è®¡ç®—ä¸Šå¼çš„æ¢¯åº¦ï¼š</p>

\[\begin{aligned} \frac{\mathrm{d} \ell}{\mathrm{d} \theta} &amp;=\frac{\mathrm{d} \mathcal{L}}{\mathrm{d} \theta}=\frac{\partial L(\mathbf{z}(S))}{\partial \mathbf{z}(S)} \frac{\mathrm{d} \mathbf{z}(S)}{\mathrm{d} \theta}-\mathbf{a}^{\top}(S) \frac{\mathrm{d} \mathbf{z}(S)}{\mathrm{d} \theta}-\mathbf{a}^{\top}(0) \frac{\mathrm{d} \mathbf{z}(0)}{\mathrm{d} \theta} \\ &amp;+\int_{0}^{S}\left[\dot{\mathbf{a}}^{\top} \frac{\mathrm{d} \mathbf{z}}{\mathrm{d} \theta}+\mathbf{a}^{\top}\left(\frac{\partial f_{\theta}}{\partial \theta}+\frac{\partial f_{\theta}}{\partial \mathbf{z}} \frac{\mathrm{d} \mathbf{z}}{\mathrm{d} \theta}+\frac{\partial f_{\theta}}{\partial \mathbf{x}} \frac{\mathrm{d} \mathbf{x}}{\mathrm{d} \theta}+\frac{\partial f_{\theta}}{\partial \tau} \frac{\mathrm{d} f}{\partial \theta}\right)+\frac{\partial l}{\partial \mathbf{z}} \frac{\mathrm{d} \mathbf{z}}{\mathrm{d} \theta}+\frac{\partial l}{\partial \tau} \frac{\mathrm{d} f}{\mathrm{~d} \theta}\right] \mathrm{d} \tau \end{aligned}\]

<p>æ•´ç†å¾—åˆ°äº†ï¼š</p>

\[\begin{aligned} 
\frac{\mathrm{d} \ell}{\mathrm{d} \theta} &amp;=\left[\frac{\partial L}{\partial \mathbf{z}(S)}-\mathbf{a}^{\top}(S)\right] \frac{\mathrm{d} \mathbf{z}(S)}{\mathrm{d} \theta}+
\\ 
&amp;+\int_{0}^{S}\left(\dot{\mathbf{a}}^{\top}+\mathbf{a}^{\top} \frac{\partial f_{\theta}}{\partial \mathbf{z}}+\frac{\partial l}{\partial \mathbf{z}}\right) \frac{\mathrm{d} \mathbf{z}}{\mathrm{d} \theta} \mathrm{d} \tau 
\\ 
&amp;+\int_{0}^{S} \mathbf{a}^{\top} \frac{\partial f_{\theta}}{\partial \theta} \mathrm{d} \tau \end{aligned}\]

<p>åŒæ ·çš„é€šè¿‡è®¡ç®—å¯¹å¶é—®é¢˜ï¼Œå¾—åˆ°äº†ä¸€ä¸ªå…³äº $\mathbf{z}(s)$ ä»¥åŠæ§åˆ¶ $\mathbf{z}(s)$ çš„å‚æ•° $\theta$ çš„æ¢¯åº¦çš„åŠ¨åŠ›ç³»ç»Ÿ</p>

\[\left\{\begin{array}{l}
\mathbf{a}^{\top}(s) = \frac{\partial L}{\partial \mathbf{z}(s)} 
\\
\dot{\mathbf{a}}^{\top}(s)=-\mathbf{a}^{\top}(s) \frac{\partial f_{\theta}}{\partial \mathbf{z}}-\frac{\partial l}{\partial \mathbf{z}} 
\\
\frac{\mathrm{d} \ell}{\mathrm{d} \theta}=\int_{0}^{S} \mathbf{a}^{\top} \frac{\partial f_{\theta}}{\partial \theta} \mathrm{d} \tau
\end{array}\right.\]

<p>æœ¬æ¥é—®é¢˜ä¼šå›åˆ°ï¼š$\frac{\mathrm{d} \ell}{\mathrm{d} \theta}=\int_{0}^{S} \mathbf{a}^{\top} \frac{\partial f_{\theta}}{\partial \theta} \mathrm{d} \tau$  å†ä»£å…¥æ¡ä»¶ï¼š$\mathbf{a}^{\top}(s) = \frac{\partial L}{\partial \mathbf{z}(s)} $ ï¼Œå†æŠŠè¿™ä¸ªç»“æœæŒ‰ç…§è®¡ç®—æœºçš„è¿ç®—çš„æƒ…å†µæ‹†æˆä¸€ä¸ªç¦»æ•£çš„ $[0,S]$ åŒºé—´ä¸Šçš„æ±‚å’Œï¼š</p>

\[\frac{\mathrm{d} \ell}{\mathrm{d} \theta}=\Sigma_{p} \mathbf{a}^{\top} \frac{\partial f_{\theta}}{\partial \theta} = \Sigma_{p} \frac{\partial L}{\partial \mathbf{z}}  \frac{\partial f_{\theta}}{\partial \theta}\]

<p>ä¸Šå¼æ˜¯ç­‰ä»·äº Backpropagation çš„ï¼Œä½†æ˜¯ç”±äº nerual ode çš„çŠ¶æ€æ˜¯ç”±ä¸€ä¸ªåŠ¨åŠ›ç³»ç»Ÿæ§åˆ¶çš„ï¼Œåˆ™å¯ä»¥æŠŠæ¢¯åº¦ä¸‹é™é—®é¢˜è½¬åŒ–æˆä¸€ä¸ª ODE solver é—®é¢˜ï¼š</p>

\[\frac{d \mathbf{a}_{a u g}(t)}{d t}
 =-\left[\begin{array}{lll}\mathbf{a}^{\top}(t) &amp; \mathbf{a}^{\top}_{\theta}(t) &amp; \mathbf{a}_{t}^{\top}(t)\end{array}\right] \frac{\partial f_{a u g}}{\partial[\mathbf{z}, \theta, t]}(t)
 =-\left[\begin{array}{lll}\mathbf{a}^{\top} \frac{\partial f}{\partial \mathbf{z}} &amp; \mathbf{a}^{\top} \frac{\partial f}{\partial \theta} &amp; \left.\mathbf{a}^{\top} \frac{\partial f}{\partial t}\right](t)\end{array}\right.\]

<p>ç„¶åé€‰å–åˆé€‚çš„ ODE solver å°±å¾—åˆ°äº†æ²¿ç€è§£è½¨çº¿çš„ä¼˜åŒ–æ‰€éœ€è¦çš„æ¢¯åº¦</p>

:ET